name: Backend Integration Tests

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  integration-tests:
    name: Backend Integration Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: server
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          if [ -z "$OPENAI_API_KEY" ] || [ -z "$PINECONE_API_KEY" ]; then
            echo "Missing OPENAI_API_KEY or PINECONE_API_KEY repository secrets."
            echo "Configure these in: Settings -> Secrets and variables -> Actions"
            exit 1
          fi

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync --dev

      - name: Run backend integration tests
        run: uv run python run_integration_tests.py --plain
